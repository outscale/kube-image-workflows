name: Build images

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  date:
    outputs:
      date: ${{ steps.date.outputs.date }}
    runs-on: [ubuntu-latest]
    steps:
    - name: ðŸ“† Compute date
      id: date
      run: |
        date=`date +%Y-%m-%d`
        echo "date=$date" | tee "$GITHUB_OUTPUT"
  build:
    needs: [date]
    outputs:
      output_ubuntu_2204: ${{ steps.build.outputs.output_ubuntu_2204 }}
      output_ubuntu_2404: ${{ steps.build.outputs.output_ubuntu_2404 }}
      runc_version: ${{ steps.build.outputs.runc_version }}
      containerd_version: ${{ steps.build.outputs.containerd_version }}
    strategy:
        matrix:
            REGION: ["us-east-2", "eu-west-2", "cloudgouv-eu-west-1"]
            TARGET: ["ubuntu-2204", "ubuntu-2404"]
    runs-on: [self-hosted, linux, "${{ matrix.REGION }}"]
    environment: ${{ matrix.REGION }}
    steps:
    - name: â¬‡ï¸ Checkout repository
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
    - name: â¬‡ï¸ Checkout image builder repository
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
      with:
        repository: 'kubernetes-sigs/image-builder'
        path: "image-builder"
        ref: ${{ vars.IMAGE_BUILDER_VERSION}}
    - name: â¬‡ï¸ Install ansible
      run: |
        python3 -m pip install ansible
    - name: â¬‡ï¸ Install deps
      run: |
        cd image-builder/images/capi
        make deps-osc
    - name: ðŸ“¦ Build image
      id: build
      run: |
        set -ex
        cd image-builder/images/capi
        useradd imagebuilder
        sed -i 's/"type": "ansible"/"type": "ansible","user":"imagebuilder"/' packer/outscale/packer.json
        sed -i 's/1.5.0/1.6.0-beta.1/' packer/outscale/config.pkr.hcl
        KUBERNETES_VERSION=`echo $KUBERNETES_VERSION | cut -d - -f 1`
        SERIES=`echo $KUBERNETES_VERSION | sed 's/\(v1.[1-9][0-9]\).*$/\1/'`
        DEB=`echo $KUBERNETES_VERSION | sed 's/v//'`
        date=${{ needs.date.outputs.date }}
        omi_name=${{ matrix.TARGET }}-kubernetes-$KUBERNETES_VERSION-$date
        source_ip=`curl https://api.ipify.org`
        if [ -z "$RUNC_VERSION" ]; then
          RUNC_VERSION=`jq -r .runc_version packer/config/containerd.json`
        fi
        if [ -z "$CONTAINERD_VERSION" ]; then
          CONTAINERD_VERSION=`jq -r .containerd_version packer/config/containerd.json`
        fi
        export PACKER_FLAGS="--var runc_version=$RUNC_VERSION --var containerd_version=$CONTAINERD_VERSION --var kubernetes_semver=$KUBERNETES_VERSION --var kubernetes_series=$SERIES --var kubernetes_deb_version=$DEB-1.1 --var overwrite_existing=true --var omi_name=$omi_name --var ssh_source_cidr=$source_ip/32"
        make build-osc-${{ matrix.TARGET }}
        target=`echo ${{ matrix.TARGET }} | sed 's/-/_/g'`
        echo "output_$target=$omi_name" >> $GITHUB_OUTPUT
        echo "IMAGE_NAME=$omi_name" >> $GITHUB_ENV
        echo "runc_version=$RUNC_VERSION" >> $GITHUB_OUTPUT
        echo "containerd_version=$CONTAINERD_VERSION" >> $GITHUB_OUTPUT
      env:
        KUBERNETES_VERSION: ${{ github.ref_name }}
        OSC_ACCESS_KEY: ${{ secrets.OSC_ACCESS_KEY }}
        OSC_SECRET_KEY: ${{ secrets.OSC_SECRET_KEY }}
        OSC_REGION: ${{ matrix.REGION }}
        OSC_ACCOUNT_ID: ${{ secrets.OSC_ACCOUNT_ID }}
        RUNC_VERSION: ${{ vars.RUNC_VERSION}}
        CONTAINERD_VERSION: ${{ vars.CONTAINERD_VERSION}}
    - name: ðŸ§¹ Frieza
      uses: outscale/frieza-github-actions/frieza-clean@master
      with:
        access_key: ${{ secrets.OSC_ACCESS_KEY }}
        secret_key: ${{ secrets.OSC_SECRET_KEY }}
        region: ${{ matrix.REGION }}
    - name: ðŸ‘· Deploy test cluster
      if: matrix.REGION != 'cloudgouv-eu-west-1' 
      id: caposc
      uses: outscale/cluster-api-provider-outscale/github_actions/deploy_cluster@main
      with:
        RUNNER_NAME: ${{ runner.name }}
        OKS_ACCESS_KEY: ${{ secrets.OKS_ACCESS_KEY }}
        OKS_SECRET_KEY: ${{ secrets.OKS_SECRET_KEY }}
        OKS_REGION: ${{ vars.OKS_REGION }}
        OSC_ACCESS_KEY: ${{ secrets.OSC_ACCESS_KEY }}
        OSC_SECRET_KEY: ${{ secrets.OSC_SECRET_KEY }}
        OSC_REGION: ${{ matrix.REGION }}
        CLUSTER_NAME: "image-builder"
        IMAGE_NAME: "${{ env.IMAGE_NAME }}"
        CCM: false
  release:
    needs: [build]
    runs-on: [ubuntu-latest]
    steps:
    - name: "ðŸš€ Publish release"
      uses: "actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd" # v8
      env:
        IMAGE_UBUNTU_2204: ${{ needs.build.outputs.output_ubuntu_2204 }}
        IMAGE_UBUNTU_2404: ${{ needs.build.outputs.output_ubuntu_2404 }}
        RUNC_VERSION: ${{ needs.build.outputs.runc_version }}
        CONTAINERD_VERSION: ${{ needs.build.outputs.containerd_version }}
        IMAGE_BUILDER_VERSION: ${{ vars.IMAGE_BUILDER_VERSION }}
      with:
        retries: 3
        debug: true
        script: |
            let body = "OMIs built with:\n" +
              "* image-builder: " + process.env.IMAGE_BUILDER_VERSION + "\n"+
              "* runc: " + process.env.RUNC_VERSION + "\n" +
              "* containerd: " + process.env.CONTAINERD_VERSION + "\n" +
              "\nNew OMIs:\n" +
              "* " + process.env.IMAGE_UBUNTU_2204 + "\n" +
              "* " + process.env.IMAGE_UBUNTU_2404
            await github.rest.repos.createRelease({
              draft: false,
              name: "Kubernetes OMI "+process.env.GITHUB_REF_NAME,
              body: body,
              owner: context.repo.owner,
              prerelease: false,
              repo: context.repo.repo,
              tag_name: process.env.GITHUB_REF_NAME,
            });
