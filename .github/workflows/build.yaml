name: Build images

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    strategy:
        matrix:
            REGION: ["us-east-2", "eu-west-2", "cloudgouv-eu-west-1"]
            TARGET: ["ubuntu-2204", "ubuntu-2404"]
    runs-on: [self-hosted, linux, "${{ matrix.REGION }}"]
    environment: ${{ matrix.REGION }}
    steps:
    - name: ‚¨áÔ∏è Checkout repository
      uses: actions/checkout@v4
    - name: ‚¨áÔ∏è Checkout image builder repository
      uses: actions/checkout@v4
      with:
        repository: 'outscale/kubernetes-image-builder'
        path: "image-builder"
        ref: "image_name"
    - name: ‚¨áÔ∏è Install ansible
      run: |
        python3 -m pip install ansible
    - name: ‚¨áÔ∏è Install deps
      run: |
        cd image-builder/images/capi
        make deps-osc
    - name: üì¶ Build image
      run: |
        cd image-builder/images/capi
        useradd imagebuilder
        sed -i 's/"type": "ansible"/"type": "ansible","user":"imagebuilder"/' packer/outscale/packer.json
        SERIES=`echo $KUBERNETES_VERSION | sed 's/\(v1.[1-9][0-9]\).*$/\1/'`
        DEB=`echo $KUBERNETES_VERSION | sed 's/v//'`
        export PACKER_FLAGS="--var kubernetes_semver=$KUBERNETES_VERSION --var kubernetes_series=$SERIES --var kubernetes_deb_version=$DEB-1.1 --var overwrite_existing=true"
        make build-osc-${{ matrix.TARGET }}
        date=`date +%Y-%m-%d`
        echo "IMAGE_NAME=${{ matrix.TARGET }}-kubernetes-$KUBERNETES_VERSION-$date" | tee $GITHUB_ENV
      env:
        KUBERNETES_VERSION: ${{ github.ref_name }}
        OSC_ACCESS_KEY: ${{ secrets.OSC_ACCESS_KEY }}
        OSC_SECRET_KEY: ${{ secrets.OSC_SECRET_KEY }}
        OSC_REGION: ${{ matrix.REGION }}
        OSC_ACCOUNT_ID: ${{ secrets.OSC_ACCOUNT_ID }}
    - name: üßπ Frieza
      uses: outscale/frieza-github-actions/frieza-clean@master
      with:
        access_key: ${{ secrets.OSC_ACCESS_KEY }}
        secret_key: ${{ secrets.OSC_SECRET_KEY }}
        region: ${{ matrix.REGION }}
    - name: üë∑ Deploy test cluster
      id: caposc
      uses: outscale/cluster-api-provider-outscale/github_actions/deploy_cluster@main
      with:
        RUNNER_NAME: ${{ runner.name }}
        OKS_ACCESS_KEY: ${{ secrets.OKS_ACCESS_KEY }}
        OKS_SECRET_KEY: ${{ secrets.OKS_SECRET_KEY }}
        OKS_REGION: ${{ vars.OKS_REGION }}
        OSC_ACCESS_KEY: ${{ secrets.OSC_ACCESS_KEY }}
        OSC_SECRET_KEY: ${{ secrets.OSC_SECRET_KEY }}
        OSC_REGION: ${{ matrix.REGION }}
        CLUSTER_NAME: "image-builder"
        IMAGE_NAME: "${{ env.IMAGE_NAME }}"
        CCM: false
    - name: "üöÄ Publish release"
      uses: "actions/github-script@v6"
      env:
        IMAGE_REGION: ${{ matrix.REGION }}
      with:
        github-token: "${{ secrets.RELEASE_GITHUB_TOKEN }}"
        retries: 3
        debug: true
        script: |
          try {
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: process.env.GITHUB_REF_NAME,
            });
            console.log(release);
            try {
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.data.id,
                body: release.data.body+"\n* "+process.env.IMAGE_NAME+" ("+process.env.IMAGE_REGION+")",
              });
            } catch (error) {
                if (error.response) {
                  console.error(`Error! Status: ${error.response.status}. Message: ${error.response.data.message}`)
                }
                console.error(error)
            }
          } catch (error) {
            await github.rest.repos.createRelease({
              draft: false,
              name: "Kubernetes "+process.env.GITHUB_REF_NAME,
              body: "New images:\n* "+process.env.IMAGE_NAME+" ("+process.env.IMAGE_REGION+")",
              owner: context.repo.owner,
              prerelease: false,
              repo: context.repo.repo,
              tag_name: process.env.GITHUB_REF_NAME,
            });
          }
