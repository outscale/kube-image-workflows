name: Build images

on:
  push:
    tags:
      - "v*"

jobs:
  date:
    outputs:
      date: ${{ steps.date.outputs.date }}
    runs-on: [ubuntu-latest]
    steps:
    - name: 📆 Compute date
      id: date
      run: |
        date=`date +%Y-%m-%d`
        echo "date=$date" | tee "$GITHUB_OUTPUT"
  build:
    needs: [date]
    outputs:
      output_ubuntu_2204: ${{ steps.build.outputs.output_ubuntu_2204 }}
      output_ubuntu_2404: ${{ steps.build.outputs.output_ubuntu_2404 }}
    strategy:
        matrix:
            REGION: ["us-east-2", "eu-west-2", "cloudgouv-eu-west-1"]
            TARGET: ["ubuntu-2204", "ubuntu-2404"]
    runs-on: [self-hosted, linux, "${{ matrix.REGION }}"]
    environment: ${{ matrix.REGION }}
    steps:
    - name: ⬇️ Checkout repository
      uses: actions/checkout@v4
    - name: ⬇️ Checkout image builder repository
      uses: actions/checkout@v4
      with:
        repository: 'outscale/kubernetes-image-builder'
        path: "image-builder"
        ref: "image_name"
    - name: ⬇️ Install ansible
      run: |
        python3 -m pip install ansible
    - name: ⬇️ Install deps
      run: |
        cd image-builder/images/capi
        make deps-osc
    - name: 📦 Build image
      id: build
      run: |
        cd image-builder/images/capi
        useradd imagebuilder
        sed -i 's/"type": "ansible"/"type": "ansible","user":"imagebuilder"/' packer/outscale/packer.json
        SERIES=`echo $KUBERNETES_VERSION | sed 's/\(v1.[1-9][0-9]\).*$/\1/'`
        DEB=`echo $KUBERNETES_VERSION | sed 's/v//'`
        date=${{ needs.date.outputs.date }}
        omi_name=${{ matrix.TARGET }}-kubernetes-$KUBERNETES_VERSION-$date
        source_ip=`curl https://api.ipify.org`
        export PACKER_FLAGS="--var kubernetes_semver=$KUBERNETES_VERSION --var kubernetes_series=$SERIES --var kubernetes_deb_version=$DEB-1.1 --var overwrite_existing=true --var omi_name=$omi_name --var ssh_source_cidr=$source_ip/32"
        make build-osc-${{ matrix.TARGET }}
        target=`echo ${{ matrix.TARGET }} | sed 's/-/_/g'`
        echo "output_$target=$omi_name" >> "$GITHUB_OUTPUT"
        echo "IMAGE_NAME=$omi_name" >> $GITHUB_ENV
      env:
        KUBERNETES_VERSION: ${{ github.ref_name }}
        OSC_ACCESS_KEY: ${{ secrets.OSC_ACCESS_KEY }}
        OSC_SECRET_KEY: ${{ secrets.OSC_SECRET_KEY }}
        OSC_REGION: ${{ matrix.REGION }}
        OSC_ACCOUNT_ID: ${{ secrets.OSC_ACCOUNT_ID }}
    - name: 🧹 Frieza
      uses: outscale/frieza-github-actions/frieza-clean@master
      with:
        access_key: ${{ secrets.OSC_ACCESS_KEY }}
        secret_key: ${{ secrets.OSC_SECRET_KEY }}
        region: ${{ matrix.REGION }}
    - name: 👷 Deploy test cluster
      id: caposc
      uses: outscale/cluster-api-provider-outscale/github_actions/deploy_cluster@main
      with:
        RUNNER_NAME: ${{ runner.name }}
        OKS_ACCESS_KEY: ${{ secrets.OKS_ACCESS_KEY }}
        OKS_SECRET_KEY: ${{ secrets.OKS_SECRET_KEY }}
        OKS_REGION: ${{ vars.OKS_REGION }}
        OSC_ACCESS_KEY: ${{ secrets.OSC_ACCESS_KEY }}
        OSC_SECRET_KEY: ${{ secrets.OSC_SECRET_KEY }}
        OSC_REGION: ${{ matrix.REGION }}
        CLUSTER_NAME: "image-builder"
        IMAGE_NAME: "${{ env.IMAGE_NAME }}"
        CCM: false
  release:
    needs: [build]
    runs-on: [self-hosted, linux]
    steps:
    - name: "🚀 Publish release"
      uses: "actions/github-script@v6"
      env:
        IMAGE_REGION: ${{ matrix.REGION }}
      with:
        github-token: "${{ secrets.RELEASE_GITHUB_TOKEN }}"
        retries: 3
        debug: true
        script: |
            await github.rest.repos.createRelease({
              draft: false,
              name: "Kubernetes "+process.env.GITHUB_REF_NAME,
              body: "New images: "+needs.build.outputs.values().join(", "),
              owner: context.repo.owner,
              prerelease: false,
              repo: context.repo.repo,
              tag_name: process.env.GITHUB_REF_NAME,
            });
